<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>MicNuke | åµæ¶ç¥å™¨ 2.0</title>
<link rel="icon" type="image/png" sizes="512x512" href="IMG_20260220_102357.png?v=14">
<link rel="apple-touch-icon" sizes="512x512" href="IMG_20260220_102357.png?v=14">
<link rel="manifest" href="manifest.json?v=14">
<style>
  /* --- çµ‚æ¥µç‰ˆ UI èˆ‡ é˜²æ”¾å¤§å„ªåŒ– --- */
  html, body {
    /* 2. é—œéµå„ªåŒ–ï¼šç¦æ­¢å…¨ç¶²é é›™æ“Šç¸®æ”¾ï¼Œä½†ä¿ç•™æ²å‹• */
    touch-action: manipulation;
  }

  body { 
    background: radial-gradient(circle at 50% 0%, #1a1a24 0%, #050505 80%); 
    display: flex; flex-direction: column; align-items: center; 
    min-height: 100vh; margin: 0; padding: 20px 0 80px 0; 
    font-family: "Impact", -apple-system, sans-serif; user-select: none; -webkit-user-select: none; 
    overflow-x: hidden;
  }

  /* ğŸ“³ è¢å¹•éœ‡å‹•ç‰¹æ•ˆ */
  .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
  @keyframes shake { 10%, 90% { transform: translate3d(-2px, 2px, 0); } 20%, 80% { transform: translate3d(2px, -2px, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 4px, 0); } 40%, 60% { transform: translate3d(4px, -4px, 0); } }

  /* --- æ¨™é¡Œèˆ‡é »è­œ --- */
  .header { text-align: center; margin-bottom: 15px; position: relative; }
  .main-title { font-size: 3.5rem; margin: 0; color: #fff; font-style: italic; letter-spacing: 2px; text-shadow: 0 0 10px #00E5FF, 0 0 30px #00E5FF; display: flex; align-items: center; justify-content: center; gap: 10px; }
  .sub-title { font-size: 1rem; margin: 5px 0 0 0; color: #FFEA00; letter-spacing: 6px; text-shadow: 0 0 10px rgba(255,234,0,0.8); font-family: sans-serif; font-weight: bold; }
  
  /* ğŸ“Š å‹•æ…‹é »è­œ */
  .eq { display: flex; gap: 4px; height: 30px; align-items: flex-end; opacity: 0.3; transition: 0.3s; }
  .eq.playing { opacity: 1; filter: drop-shadow(0 0 10px #00E5FF); }
  .eq span { display: block; width: 6px; background: #00E5FF; border-radius: 3px; height: 5px; transition: height 0.1s; }
  .eq.playing span { animation: bounce 0.5s infinite alternate ease-in; }
  .eq.playing span:nth-child(1) { animation-delay: 0.1s; } .eq.playing span:nth-child(2) { animation-delay: 0.3s; } .eq.playing span:nth-child(3) { animation-delay: 0.0s; }
  @keyframes bounce { 0% { height: 5px; } 100% { height: 30px; } }

  /* --- æ§åˆ¶å°ï¼šé–‹é—œèˆ‡ç·Šæ€¥ç…è»Š --- */
  .control-panel { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 90%; max-width: 400px; margin-bottom: 20px; font-family: sans-serif; font-weight: bold; font-size: 13px; }
  .toggle-label { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px; border: 1px solid #333; color: #aaa; cursor: pointer; transition: 0.3s; touch-action: manipulation; }
  .toggle-label.active-10x { color: #FF1744; border-color: #FF1744; box-shadow: 0 0 10px rgba(255,23,68,0.3); }
  .toggle-label.active-combo { color: #00E676; border-color: #00E676; box-shadow: 0 0 10px rgba(0,230,118,0.3); }
  input[type="checkbox"] { display: none; }
  
  #panic-btn { width: 100%; background: #FF1744; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: 900; font-size: 16px; letter-spacing: 2px; box-shadow: 0 0 15px rgba(255,23,68,0.5); cursor: pointer; transition: 0.1s; touch-action: manipulation; }
  #panic-btn:active { transform: scale(0.95); background: #C50028; }

  /* --- éµç›¤æ¯›ç»ç’ƒåº•ç›¤ --- */
  #keyboard { background: rgba(20, 20, 25, 0.4); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); width: 90%; max-width: 400px; padding: 20px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.9), inset 0 2px 2px rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-content: start; }

  /* âš¡ æŒ‰éˆ•é€²å ´å‹•ç•«èˆ‡éœ“è™¹ */
  .key-cap { 
    aspect-ratio: 1.4/1; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
    font-size: clamp(18px, 5vw, 22px); font-weight: 900; transition: all 0.1s ease-out; -webkit-tap-highlight-color: transparent; 
    background: transparent; border: 2px solid var(--neon); color: #fff; 
    box-shadow: 0 0 10px var(--neon), inset 0 0 10px var(--neon); text-shadow: 0 0 8px var(--neon), 0 0 20px var(--neon);
    font-family: sans-serif; opacity: 0; animation: fade-in-up 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    
    /* 3. é‡è¦ï¼šå–®ç¨ç‚ºæŒ‰éˆ•åŠ ä¸Š touch-action: none å¾¹åº•é–æ­»é›™æ“Šç¸®æ”¾çš„å¯èƒ½æ€§ */
    touch-action: none;
  }
  @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
  
  .key-cap:active { transform: scale(0.92) !important; background: var(--neon); color: #000; box-shadow: 0 0 25px var(--neon), 0 0 50px var(--neon); text-shadow: none; }
  .key-top { pointer-events: none; text-align: center; padding: 5px; word-break: break-word; line-height: 1.2; }

  .c0 { --neon: #FF1744; } .c1 { --neon: #FFEA00; } .c2 { --neon: #00E676; } .c3 { --neon: #2979FF; }
  .c4 { --neon: #D500F9; } .c5 { --neon: #00E5FF; } .c6 { --neon: #FF9100; } .c7 { --neon: #FF4081; }

  /* --- å½ˆå‡ºè¦–çª— --- */
  #msg-box { position: fixed; top: 20px; background: rgba(20,20,25,0.95); color: #00E5FF; border: 1px solid #00E5FF; padding: 10px 25px; border-radius: 30px; font-weight: bold; box-shadow: 0 0 15px rgba(0,229,255,0.3); z-index: 10; transition: 0.3s; }
  #toast { position: fixed; bottom: 30px; background: rgba(20,20,25,0.95); color: #FFEA00; border: 1px solid #FFEA00; padding: 12px 24px; border-radius: 30px; font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 100; transform: translateY(20px); }
  .show { opacity: 1 !important; transform: translateY(0) !important; }
  #install-prompt { position: fixed; bottom: -100px; width: 90%; max-width: 500px; background: rgba(15,15,18,0.95); border: 1px solid #333; color: #fff; padding: 15px 20px; border-radius: 16px; display: flex; align-items: center; transition: 0.5s; z-index: 999; }
  #install-prompt.up { bottom: 25px; }
  #install-btn { background: #00E676; color: #000; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin: 0 10px 0 auto; box-shadow: 0 0 10px rgba(0,230,118,0.5); }
</style>
</head>
<body>

  <div class="header">
    <h1 class="main-title">
      MicNuke
      <div class="eq" id="eq"><span></span><span></span><span></span></div>
    </h1>
    <p class="sub-title">åµæ¶ç¥å™¨ 2.0</p>
  </div>

  <div class="control-panel">
    <label class="toggle-label active-10x" id="lbl-10x">
      <input type="checkbox" id="boost-switch" checked> â˜¢ï¸ 10X ç‚¸éº¥
    </label>
    <label class="toggle-label" id="lbl-combo">
      <input type="checkbox" id="combo-switch"> ğŸ”„ ç„¡é™ç–ŠéŸ³
    </label>
    <button id="panic-btn">ğŸ›‘ ç·Šæ€¥ç…è»Š (SHUT UP!)</button>
  </div>

  <div id="msg-box">ğŸ“¡ æ­¦å™¨åº«é€£ç·šä¸­...</div>
  <div id="toast"></div>

  <div id="install-prompt">
    <div style="flex-grow:1; line-height: 1.4; font-family:sans-serif;">ğŸ’¡ <b>åŠ åˆ°ä¸»ç•«é¢</b><br>è§£é™¤å°å°è®Šå¯¦é«” Appï¼</div>
    <button id="install-btn">å®‰è£</button>
    <button style="background:none; border:none; color:white; font-size:16px;" onclick="closePWA()">âœ•</button>
  </div>

  <div id="keyboard"></div>

  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vROxIxBE1TSv_SAP17SGB4zfCC5QQvTycjUpSf366-OO-2MWB6xSPS6-SdBJ0azjBkEXd6JNohJvWbZ/pub?output=csv";
    const $ = id => document.getElementById(id);
    let audioCtx, gainNode, deferredPrompt;
    let activeAudios = [];

    const showToast = msg => { $('toast').innerText = msg; $('toast').classList.add('show'); setTimeout(() => $('toast').classList.remove('show'), 2000); };

    $('boost-switch').onchange = e => $('lbl-10x').classList.toggle('active-10x', e.target.checked);
    $('combo-switch').onchange = e => $('lbl-combo').classList.toggle('active-combo', e.target.checked);

    window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredPrompt = e; });
    $('install-btn').onclick = async () => {
      if (deferredPrompt) { deferredPrompt.prompt(); if ((await deferredPrompt.userChoice).outcome === 'accepted') closePWA(); deferredPrompt = null; } 
      else { alert(/iPad|iPhone/.test(navigator.userAgent) ? "ğŸ é»æ“Šåº•éƒ¨ã€Œåˆ†äº« ğŸ“¤ã€â”ã€ŒåŠ å…¥ä¸»ç•«é¢ â•ã€" : "ğŸ¤– é»æ“Šå³ä¸Šè§’ã€Œ â‹® ã€â”ã€ŒåŠ åˆ°ä¸»ç•«é¢ã€"); }
    };
    const closePWA = () => { $('install-prompt').classList.remove('up'); localStorage.setItem('hidePWA', '1'); };
    window.addEventListener('DOMContentLoaded', () => { if (/Mobile|Android|iPhone/i.test(navigator.userAgent) && !window.matchMedia('(display-mode: standalone)').matches && !localStorage.getItem('hidePWA')) setTimeout(() => $('install-prompt').classList.add('up'), 1500); });

    fetch(SHEET_URL).then(r => r.text()).then(csv => {
      $('msg-box').style.display = 'none';
      let validCount = 0;
      csv.split('\n').slice(1).forEach(row => {
        const [name, u1, u2] = row.split(',').map(s => s?.trim());
        if (name && u1) {
          const btn = document.createElement('button');
          btn.className = `key-cap c${validCount % 8}`;
          btn.innerHTML = `<span class="key-top">${name.replace(/\\n/g, '<br>')}</span>`;
          btn.style.animationDelay = `${validCount * 0.04}s`; 
          
          // ä½¿ç”¨ onclick é…åˆ CSS touch-action: none æ˜¯ iOS æœ€ç©©å®šçš„è§£æ³•
          btn.onclick = (e) => {
            e.preventDefault(); // é˜»æ–·é è¨­è¡Œç‚º
            playAudio(u1, u2);
          };
          
          $('keyboard').appendChild(btn);
          validCount++;
        }
      });
    }).catch(() => $('msg-box').innerText = "âš ï¸ ç¶²è·¯ç•°å¸¸");

    $('panic-btn').onclick = () => {
      activeAudios.forEach(a => { a.pause(); a.src = ''; });
      activeAudios = [];
      updateEq();
      navigator.vibrate?.([50, 50, 50]);
      showToast("ğŸ›‘ å·²å¼·åˆ¶éœéŸ³");
    };

    function updateEq() {
      const isPlaying = activeAudios.some(a => !a.paused);
      $('eq').classList.toggle('playing', isPlaying);
    }

    function playAudio(u1, u2) {
      navigator.vibrate?.(50);
      document.body.classList.remove('shake');
      void document.body.offsetWidth;
      document.body.classList.add('shake');

      if (!$('combo-switch').checked) {
        activeAudios.forEach(a => { a.pause(); a.src = ''; });
        activeAudios = [];
      }

      attemptPlay(u1, u2, true);
    }

    function attemptPlay(url, fallback, useBoost) {
      if (!url) return fallback ? attemptPlay(fallback, null, true) : showToast("ğŸ”‡ ç¶²å€ç„¡æ•ˆ");
      
      let player = new Audio(url);
      activeAudios.push(player);
      player.onended = () => { updateEq(); };

      if (useBoost && $('boost-switch').checked) {
        player.crossOrigin = "anonymous";
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === 'suspended') audioCtx.resume();
          let source = audioCtx.createMediaElementSource(player);
          if (!gainNode) { gainNode = audioCtx.createGain(); gainNode.connect(audioCtx.destination); }
          gainNode.gain.value = 10.0;
          source.connect(gainNode);
        } catch(e) {}
      }

      player.play().then(() => updateEq()).catch(e => {
        activeAudios = activeAudios.filter(a => a !== player);
        updateEq();
        if (e.name !== 'AbortError') {
          if (useBoost && $('boost-switch').checked) attemptPlay(url, fallback, false);
          else if (fallback) { showToast("ğŸ”„ å˜—è©¦åˆ‡æ›å‚™ç”¨..."); attemptPlay(fallback, null, $('boost-switch').checked); }
          else showToast("ğŸ”‡ æ’­æ”¾å¤±æ•—");
        }
      });
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) $('panic-btn').click();
      else if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    });
  </script>
</body>
</html>

